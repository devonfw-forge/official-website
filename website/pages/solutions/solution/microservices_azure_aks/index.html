<!DOCTYPE html><html lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=">
<meta name="generator" content="Asciidoctor 1.5.8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ******** SOCIAL MEDIA META ********** -->

<meta name="title" property="og:title" content="devonfw website">
<meta property="og:type" content="website">
<meta name="image" property="og:image" content="https://devonfw.com/images/devonfwwebsite.png">
<meta name="description" property="og:description" content="devonfw is the standard open source software development platform; Serving the full Software Delivery Life Cycle.">
<meta property="og:url" content="https://devonfw.com/index.html">

<meta name="twitter:title" content="devonfw website">
<meta name="twitter:description" content="devonfw is the standard open source software development platform; Serving the full Software Delivery Life Cycle.">
<meta name="twitter:image" content="https://devonfw.com/images/devonfwwebsite.png">
<meta name="twitter:card" content="summary_large_image">

<!-- ************************************* -->


<title>Microservice Platforms Solutions - Azure Kubernetes Service</title>
<!-- devonfw website stylesheet -->
<link rel="stylesheet" type="text/css" href="/devonfw.css">
<!-- Lunr -->
<script src="/website/assets/scripts/lunr.min.js"></script>
<!-- JQuery -->
<script src="/website/assets/scripts/jquery.min.js"></script>
<link rel="stylesheet" href="/website/assets/styles/font-awesome.min.css">
<link rel="stylesheet" href="/website/assets/styles/googlecode.min.css">
<script src="/website/assets/scripts/highlight.min.js"></script>
<script src="/website/assets/scripts/common.min.js"></script>
<script>hljs.initHighlightingOnLoad()</script>
<link rel="stylesheet" href="/website/assets/styles/bootstrap.min.css">

<script src="/website/assets/scripts/anchor.min.js"></script>

<script src="/website/components/header/search-engine/bundle.js"></script>

<script src="/website/shared/rightmenu.js"></script>

<!-- ************** Google analytics ************ -->
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}

gtag('consent', 'default', {
  'analytics_storage': 'denied'
});
</script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-151636804-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-151636804-1');
</script>
<script>
  function consentGranted() {
    gtag('consent', 'update', {
      'analytics_storage': 'granted'
    });
  }
</script>

<!-- ******************************************** -->


</head>
<body class="article">
<div id="website-navbar" class="website-navbar">
<button id="menu-button" class="menu-button">
  <img src="/images/menu-button.svg" width="32px" height="32px" alt="">
</button>

<ul>
<li>
<p><span class="image"><a class="image" href="/website/pages/welcome/welcome.html"><img alt="logo" src="/images/Logo_devonfw.svg"></a></span></p>
</li>
<li>
<p><a href="https://killercoda.com/devonfw">Tutorials</a></p>
</li>
<li>
<p><a href="/website/pages/solutions/index.html">Solutions</a></p>
</li>
<li>
<p><a href="/website/pages/docs/master.html">Docs</a></p>
</li>
</ul>

<form class="form-inline">
  <div class="search-bar">
    <input id="search-field" type="search" class="form-control mr-sm-2" placeholder="Search by keyword(s)..." aria-label="Search" style="height: auto;" autocomplete="off">
    <div class="sb-res-pos px-4">
      <div id="click-outside" class="click-outside z-50 hidden"></div>
      <div class="col rounded px-0 border z-100 bg-white hidden search-bar-results" id="search-results-box">
      </div>
    </div>
  </div>
</form>
<a class="navbar-github text-white" href="https://github.com/devonfw/">
  <img src="/images/github-mark.png" width="auto" height="auto" alt="">
</a></div>
<div id="sidebar" class="wiki-sidebar"></div>

<div id="content" class="mt-4 mt-sm-5">
<div class="toc">
<div class="title">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#index.asciidoc">Microservice Platforms Solutions - Azure Kubernetes Service</a>
<ul class="sectlevel1">
<li><a href="#microservice-platforms-introduction">Microservice Platforms Introduction</a>
<ul class="sectlevel2">
<li><a href="#context-problem">Context &amp; Problem</a></li>
<li><a href="#introduction-to-kubernetes">Introduction to Kubernetes</a></li>
<li><a href="#standard-problems">Standard Problems</a></li>
</ul>
</li>
<li><a href="#microservice-platforms">Microservice Platforms</a>
<ul class="sectlevel2">
<li><a href="#azure">Azure</a></li>
</ul>
</li>
<li><a href="#index.asciidoc_microservice-platforms-solutions---azure-kubernetes-service">Microservice Platforms Solutions - Azure Kubernetes Service</a>
<ul class="sectlevel2">
<li><a href="#index.asciidoc_infrastructure">Infrastructure</a></li>
<li><a href="#index.asciidoc_application">Application</a></li>
</ul>
</li>
<li><a href="#index.asciidoc_credits">Credits</a></li>
</ul>
</li>
</ul>
<h1 id="index.asciidoc" class="sect0">Microservice Platforms Solutions - Azure Kubernetes Service</h1>
<div class="sect1">
<h2 id="microservice-platforms-introduction">Microservice Platforms Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="context-problem">Context &amp; Problem</h3>
<div class="paragraph">
<p>Microservice orchestration is the automatic process of managing or scheduling the work of individual microservices of an application within a cluster. The platform provides an automated process of managing, scaling, and maintaining microservices of an application.
The container orchestration platform Kubernetes is the current de facto standard (Docker swarm and others are nowadays neglectable compared to Kubernetes). Containers are units that packages up code and all its dependencies like libraries so that the application can be started quickly and runs reliably, regardless of the infrastructure.
<a href="https://avinetworks.com/glossary/container-orchestration/">Container orchestration</a> tools automate the management of various tasks that software teams encounter in a container’s lifecycle, including the following: Container deployment, scaling, load balancing and traffic routing, network and container configuration, allocation of resources, gathering of insights, provisioning, scheduling, distribution of containers to physical hosts, service discovery, health monitoring, cluster management (Link).</p>
</div>
</div>
<div class="sect2">
<h3 id="introduction-to-kubernetes">Introduction to Kubernetes</h3>
<div class="paragraph">
<p>To achieve the above goals a rough understanding of the Kubernetes structure is important.
The control plane is responsible for managing your container workload. All action in Kubernetes goes through the api-server which receives and executes commands. The workload is defined by the target state you define in so called objects. A <a href="https://stackoverflow.com/questions/52309496/difference-between-kubernetes-objects-and-resources">Kubernetes object</a> is a "record of intent" - once you create the object, the Kubernetes system will constantly work to ensure that object exists. Those definitions can exist in manifest files, or be obtained from the api-server.</p>
</div>
<div class="paragraph">
<p>Pods are the smallest, most basic deployable objects in Kubernetes. A Pod represents a single instance of a running process in your cluster. Pods contain one or more containers. When a Pod runs multiple containers, the containers are managed as a single entity and share the Pod’s resources. However, to make life considerably easier, you don’t need to manage each Pod directly. Instead, you can use workload resources that manage a set of pods on your behalf such as a "deployment". These resources configure controllers that make sure the right number of the right kind of pod are running, to match the state you specified (See <a href="https://kubernetes.io/docs/concepts/workloads/">here</a> for concepts implementing workflows).</p>
</div>
<div class="paragraph">
<p>Two major extensions can be distinguished. There is a certain overlap between both with both having a different focus. Service meshes focus at core container orchestration functionality. The other class are extensions that focus at supporting typical application patterns such as publish subscribe. Infrastructure from programming perspective falls into two categories:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Platform orchestration support: Provided by Kubernetes and service meshes</p>
</li>
<li>
<p>Application platform support: Provided by additional tools such as DAPR</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The picture below summarizes the major aspects:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="problem_context.png" alt="Container orchestration Problem Context" width="925" height="666">
</div>
</div>
</div>
<div class="sect2">
<h3 id="standard-problems">Standard Problems</h3>
<div class="paragraph">
<p>This chapter focus at problems that are unique due to the microservice focus. Links to documentation of microservice agnostic parts are given below. An example for a problem with microservice specifics and agnostic parts is provisioning. Creating the orchestration infrastructure is conceptually not different from other resources that are created with a pipeline. However, the additional container build step is specific to microservices based on a container orchestration platform.</p>
</div>
<div class="paragraph">
<p>The following standard problems regarding the <strong>orchestration platform</strong> support will be addressed in subsequent paragraphs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Deployment</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>On orchestration platform level special options exist how to create various environments. For general aspects of provisioning see the pattern "Provisioning".</p>
</div>
</div>
</div>
</li>
<li>
<p>Scaling</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Targets of scaling can be the underlying nodes (=VMs) of the orchestration cluster and the pods per node. Scaling can be manual by stating a target number of components or automatic e.g. depending on load.</p>
</div>
</div>
</div>
</li>
<li>
<p>Load balancing/traffic routing</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>This is core strategy for maximizing availability and scalability, load balancing distributes network traffic among multiple backend services efficiently. A range of options for load balancing external traffic to pods exists in the Kubernetes context, each with its own benefits and tradeoffs. <a href="https://avinetworks.com/glossary/kubernetes-load-balancer/">Basic options are</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Load Balancing with kube-proxy: Simple but not fair if clients send with different frequency</p>
</li>
<li>
<p>Kubernetes Endpoints API: Load balancer uses Kubernetes API to track availability of pods</p>
</li>
<li>
<p>Ingress Load Balancer: Most popular and allows for sophisticated load balancing rules</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The above list only shows the major hooks/ solutions that are available in Kubernetes. <a href="https://blog.envoyproxy.io/introduction-to-modern-network-load-balancing-and-proxying-a57f6ff80236">More variations</a> are possible if basic functions are taken into account:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Backend discovery</p>
</li>
<li>
<p>Health Checking</p>
</li>
<li>
<p>Distribution algorithm such as round robin</p>
</li>
<li>
<p>Protocol level e.g. OSI layer 7 or layer 4 only</p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/cluster-administration/networking/">Networking</a></p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Networking is a central part of Kubernetes, but it can be challenging to understand exactly how it is expected to work. There are 4 distinct networking problems to address:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tightly coupled container-to-container communications: this is solved by ** Pods and localhost communications.</p>
</li>
<li>
<p>Pod-to-Pod communications: this is the primary focus of this document.</p>
</li>
<li>
<p>Pod-to-Service communications: this is covered by services.</p>
</li>
<li>
<p>External-to-Service communications: this is covered by services.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Kubernetes uses the following model to organize networking. Every Pod gets its own IP address. This means you do not need to explicitly create links between Pods and you almost never need to deal with mapping container ports to host ports. Pods on a node can communicate with all pods on all nodes without NAT. Kubernetes IP addresses exist at the Pod scope - containers within a Pod share their network namespaces - including their IP address and MAC address. This means that containers within a Pod can all reach each other’s ports on localhost.</p>
</div>
</div>
</div>
</li>
<li>
<p>Configuration</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Configuration has various dimensions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Sensitive versus non-sensitive information</p>
</li>
<li>
<p>Orchestration platform versus application settings</p>
</li>
<li>
<p>Automatic deployment of configuration settings versus manual</p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>Scheduling</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>In Kubernetes, scheduling refers to making sure that Pods are matched to Nodes so that the kubelet can run them. Preemption is the process of terminating Pods with lower Priority so that Pods with higher Priority can schedule on Nodes. <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/">Eviction</a> is the process of terminating one or more Pods on Nodes.</p>
</div>
<div class="paragraph">
<p><a href="https://kubernetes.io/docs/concepts/scheduling-eviction/kube-scheduler/">Factors</a> that need to be taken into account for scheduling decisions include individual and collective resource requirements, hardware / software / policy constraints, affinity and anti-affinity specifications, data locality, inter-workload interference, and so on.</p>
</div>
</div>
</div>
</li>
<li>
<p>Service discovery</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><a href="https://platform9.com/blog/kubernetes-service-discovery-principles-in-practice/">Service discovery</a> is the actual process of figuring out how to connect to a service (Link). The <a href="https://microservices.io/patterns/service-registry.html">approach</a> can be either (1) client or (2) server driven.</p>
</div>
<div class="paragraph">
<p>In case of <strong>client-side discovery</strong> the client is responsible for determining which service instance it should connect to. It does that by contacting a service registry component, which keeps records of all the running services and their endpoints. When a new service gets added or another one dies, the Service Registry is automatically updated. It is the client’s responsibility to load-balance and distribute its request load on the available services.</p>
</div>
<div class="paragraph">
<p>In the <strong>server-side discovery</strong> a load-balancing layer exists in front of the service instances. The client connects to the well-defined URL of the load balancer and the latter determines which backend service it shall route the request too. Because a Pod can be moved or rescheduled to another Node, any internal IPs that this Pod is assigned can change over time. If we were to connect to this Pod to access our application, it would not work on the next re-deployment. To make a Pod reachable to external networks or clusters without relying on any internal IPs, we need another layer of abstraction. Services provide network connectivity to Pods that work uniformly across clusters.  Each service exposes an IP address, and may also expose a DNS endpoint — both of which will never change. Internal or external consumers that need to communicate with a set of pods will use the service’s IP address, or its more generally known DNS endpoint. In this way, the service acts as the glue for connecting pods with other pods.</p>
</div>
</div>
</div>
</li>
<li>
<p>Application services</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Standard services on application level include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Service-to-Service invocation</p>
</li>
<li>
<p>State management</p>
</li>
<li>
<p><strong>Publish &amp; Subscribe</strong>: This pattern allows microservices to communicate with each other using messages. The producer or publisher sends messages to a topic without knowledge of what application will receive them. This involves writing them to an input channel. Similarly, a consumer or subscriber subscribes to the topic and receive its messages without any knowledge of what service produced these messages. This involves receiving messages from an output channel. An intermediary message broker is responsible for copying each message from an input channel to an output channels for all subscribers interested in that message. This pattern is especially useful when you need to decouple microservices from one another.</p>
</li>
<li>
<p><strong>Resource &amp; Binding Triggers:</strong> Using bindings, you can trigger your app with events coming in from external systems, or interface with external systems.</p>
</li>
<li>
<p>Secrets</p>
</li>
</ul>
</div>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following standard problems regarding <strong>the applications to be deployed</strong> will be addressed in subsequent paragraphs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Designing</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Mutiple options exist how many containers an application consists of. In the simplest case persistence is achieved by persistent volumes but also hosting entire databases on Kubernetes is possible.</p>
</div>
</div>
</div>
</li>
<li>
<p>Provisioning</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Container images need to be built, stored in a registry and deployed. Additional challenges during built are for instance triggering dependent images if a base image is affected or enforcing quality gates such as security scans as part of the build pipelines. Deployments might even go beyond Kubernetes if you have for instance a rolling update with database changes.</p>
</div>
</div>
</div>
</li>
<li>
<p>Compliance</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Compliance affects the building of containers and the running application such as restricting communication between containers.</p>
</div>
</div>
</div>
</li>
<li>
<p>Configuration</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Containers need to be configured. An additional challenge might therefore to inject environment specific values.</p>
</div>
</div>
</div>
</li>
<li>
<p>Monitoring</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>You can examine application performance in a Kubernetes cluster by examining the containers, pods, services, and the characteristics of the overall cluster. Kubernetes provides detailed information about an application’s resource usage at each of these levels. This information allows you to evaluate your application’s performance.</p>
</div>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="microservice-platforms">Microservice Platforms</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="azure">Azure</h3>
<div class="paragraph">
<p>This chapter lists major features/ concrete services for microservices platforms within Azure. A detailed discussion of services is part of the solution design based on a certain service.</p>
</div>
<div class="paragraph">
<p>Azure provides the following container platforms:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure Kubernetes Service (AKS)</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>It represents a hosted Kubernetes service. Additional features on  <strong>orchestration platform</strong> include the integration with other Azure services such as Azure Active Directory concepts.</p>
</div>
</div>
</div>
</li>
<li>
<p>Azure Container Instance (ACI)</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>This service is intended to run single containers without native orchestration support. However, it can be integrated into Kubernetes.</p>
</div>
</div>
</div>
</li>
<li>
<p>Azure Red Hat OpenShift (ARO)</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>It provides highly available, fully managed OpenShift clusters as <strong>orchestration platform</strong> on demand, monitored and operated jointly by Microsoft and Red Hat. Kubernetes is at the core of Red Hat OpenShift. OpenShift brings added-value features to complement Kubernetes, making it a turnkey container platform as a service (PaaS) with a significantly improved developer and operator experience.</p>
</div>
</div>
</div>
</li>
<li>
<p>Azure Container Apps (in preview as of 07.11.2021)</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Azure Container Apps allows to build serverless microservices based on containers. <a href="https://docs.microsoft.com/en-us/azure/container-apps/compare-options">Distinctive features</a> of Container Apps include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Optimized for running general purpose containers, especially for applications that span many microservices deployed in containers.</p>
</li>
<li>
<p>Powered by Kubernetes and open-source technologies like Dapr, KEDA, and envoy.</p>
</li>
<li>
<p>Supports Kubernetes-style apps and microservices with features like service discovery and traffic splitting.</p>
</li>
<li>
<p>Enables event-driven application architectures by supporting scale based on traffic and pulling from event sources like queues, including scale to zero.</p>
</li>
<li>
<p>Support of long running processes and can run background tasks.</p>
</li>
<li>
<p>All Container Apps are Kubernetes compatible.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Azure Container Apps doesn’t provide direct access to the underlying Kubernetes APIs. If you require access to the Kubernetes APIs and control plane, you should use Azure Kubernetes Service. However, if you would like to build Kubernetes-style applications and don’t require direct access to all the native Kubernetes APIs and cluster management, Container Apps provides a fully managed experience based on best-practices.</p>
</div>
</div>
</div>
</li>
<li>
<p>Azure Spring Cloud</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><a href="https://docs.microsoft.com/en-us/azure/container-apps/compare-options">Azure Spring Cloud</a> makes it easy to deploy Spring Boot microservice applications to Azure without any code changes. The service manages the infrastructure of Spring Cloud applications so developers can focus on their code. Azure Spring Cloud provides lifecycle management using comprehensive monitoring and diagnostics, configuration management, service discovery, CI/CD integration, blue-green deployments, and more. If your team or organization is predominantly Spring, Azure Spring Cloud is an ideal option.</p>
</div>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Regarding <strong>the applications to be deployed</strong> Azure comes also with its own Azure container reistry (ACR).</p>
</div>
<div class="paragraph">
<p>The picture below summarizes major points:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="microservices_azure.png" alt="Microservice Platforms Azure Overview" width="965" height="582">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="index.asciidoc_microservice-platforms-solutions---azure-kubernetes-service">Microservice Platforms Solutions - Azure Kubernetes Service</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="index.asciidoc_infrastructure">Infrastructure</h3>
<div class="sect3">
<h4 id="index.asciidoc_overview">Overview</h4>
<div class="paragraph">
<p>The solution is to use Azure Kubernetes Service and the following platform features regarding. The focus of this chapter is to introduce the relevant features. Recommendations for a concrete setup are given in the next chapter.
The platform features that (can) complement Kubernetes are:</p>
</div>
<div class="paragraph">
<p>The services that (can) complement Kubernetes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Advisory</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Proactive and actionable recommendations from Azure Advisor based on your configuration and usage telemetry as described here.</p>
</div>
</div>
</div>
</li>
<li>
<p>Provisioning</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Use Bridge to Kubernetes to iteratively develop, test, and debug microservices targeted for AKS clusters. It is a <a href="https://azure.microsoft.com/de-de/updates/azure-dev-spaces-is-retiring-on-31-october-2023/">client-only experience</a> offered through extensions in Visual Studio and Visual Studio Code. See also Provisioning for general aspects and service options for creating pipelines for creating infrastructure.</p>
</div>
</div>
</div>
</li>
<li>
<p>Compliance</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Use security measures on networking level to avoid public IPs. Combine AKS with additional services to control ingress and outgoing traffic such as Application Gateway or firewalls.</p>
</div>
<div class="paragraph">
<p>Enforce compliance rules to your cluster and CI/CD pipeline consistently with Azure Policy. Azure Active Directory provides access control with role-based-access-controls (RBAC) and service principals/ managed identities to back RBAC roles. Integration with Azure Security Center can provide security management, intelligent threat detection and actionable recommendations.</p>
</div>
</div>
</div>
</li>
<li>
<p>Desaster recovery</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Higher availability using redundancies across availability zones, protecting applications from datacenter failures. Paired region deployment for disaster recovery.</p>
</div>
</div>
</div>
</li>
<li>
<p>Monitoring</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>For infrastructure monitoring see "Monitoring". For infrastructure monitoring specific pages in Azure Monitor exist which will be described here.</p>
</div>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The picture below summarizes some of the services mentioned above:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="aks_overview.png" alt="AKS Overview" width="794" height="568">
</div>
</div>
<div class="paragraph internal">
<p>solution_microservices_azure_aks_infra_detailed_native_setup</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="index.asciidoc_application">Application</h3>
<div class="sect3">
<h4 id="index.asciidoc_overview">Overview</h4>
<div class="paragraph">
<p>The solution is to deploy the containerized application to an Azure Kubernetes Service. Focus of that chapter are designing, building, monitoring and deploying containerized applications. Recommendations for a concrete setup are given in the next chapter.</p>
</div>
<div class="paragraph">
<p>The services that (can) complement Kubernetes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Designing</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Each Pod is meant to run a single instance of a given application. If you want to scale your application horizontally (to provide more overall resources by running more instances), you should use multiple Pods, one for each instance. In Kubernetes, this is typically referred to as replication. Replicated Pods are usually created and managed as a group by a workload resource and its controller.</p>
</div>
<div class="paragraph">
<p>The "one-container-per-Pod" model is the most common Kubernetes use case. A more advanced use case is running multiple containers in a pod that need to work together. A Pod can encapsulate an application composed of multiple co-located containers that are tightly coupled and need to share resources. These co-located containers form a single cohesive unit of service - for example, one container serving data stored in a shared volume to the public, while a separate sidecar container refreshes or updates those files. The Pod wraps these containers, storage resources, and an ephemeral network identity together as a single unit.</p>
</div>
<div class="paragraph">
<p>Containers have to store information persistently. <a href="https://docs.microsoft.com/en-us/azure/aks/concepts-storage">Azure</a> provides Azure (managed) disks and Azure files as storage options for persistent volumes.
AKS can connect with databases via wrapper objects such as Services  or databases can be directly deployed to Kubernetes. Options for deplyong a database directly to Kubernetes are given below:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SQL server (Microsoft): Options range from single <a href="https://docs.microsoft.com/en-us/sql/linux/tutorial-sql-server-containers-kubernetes?view=sql-server-ver15">sql server</a> to <a href="https://docs.microsoft.com/en-us/sql/linux/tutorial-sql-server-containers-kubernetes-dh2i?view=sql-server-ver15">high availability</a> with failover groups. In both cases MS provides containers that contain sql server.</p>
</li>
<li>
<p>Third party options such as <a href="https://portworx.com/blog/ha-postgresql-azure-aks/">PostgreSQL</a></p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>Configuration</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Configmaps are useful to store non-critical data in key-value pair format. They can also be used to inject env vars into pods. Secrets are useful to store sensitive data in key value pair format. They can also be used to inject env vars into pods. You can optionally specify how much of each resource a container needs. The most common resources to specify are CPU and memory (RAM).</p>
</div>
</div>
</div>
</li>
<li>
<p>Compliance</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>A <a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/">security context</a> defines privilege and access control settings for a pod. Examples are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Discretionary Access Control: Permission to access an object, like a file, is based on user ID (UID) and group ID (GID).</p>
</li>
<li>
<p>Security Enhanced Linux (SELinux): Objects are assigned security labels.</p>
</li>
<li>
<p>Running as privileged or unprivileged.</p>
</li>
<li>
<p>Linux Capabilities: Give a process some privileges, but not all the privileges of the root user.</p>
</li>
<li>
<p>AppArmor: Use program profiles to restrict the capabilities of individual programs.</p>
</li>
<li>
<p>AllowPrivilegeEscalation: Controls whether a process can gain more privileges than its parent process.</p>
</li>
<li>
<p>readOnlyRootFilesystem: Mounts the container’s root filesystem as read-only.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Disks used in your AKS cluster can by encrypted by using your own keys through Azure Key Vault.</p>
</div>
<div class="paragraph">
<p>See building for additional security measures when containers are built.</p>
</div>
</div>
</div>
</li>
<li>
<p>Building (CI part of provisioning)</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Building containers includes the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Building the container image(s)</p>
</li>
<li>
<p>Pushing the image(s) to the registry</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Provisioning tools such as Azure DevOps and Gitub Actions provide special docker tasks/ activities to build images. Pushing to registries is also supported. The following additional features can be used/ should be considered from security perspective:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each time a <strong>base image is updated</strong>, you should also update any downstream container images. Integrate this build process into validation and deployment pipelines such as Azure Pipelines or Jenkins. These pipelines make sure that your applications continue to run on the updated based images. Once your application container images are validated, the AKS deployments can then be updated to run the latest, secure images. Azure Container Registry Tasks can also <a href="https://docs.microsoft.com/en-us/azure/aks/operator-best-practices-container-image-management">automatically update container images</a> when the base image is updated.</p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/azure/aks/operator-best-practices-container-image-management">A container security scan</a> can be included in the <strong>pipelines as quality gate</strong> by using tools like tools such as Twistlock or Aqua.</p>
</li>
<li>
<p>The <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/ecosystems/containers/content-trust?view=azure-devops">provisioning services support</a> Docker Content Trust (DCT). Docker Content Trust (DCT) are digital signatures for data sent to and received from remote Docker registries. These signatures allow client-side or runtime verification of the integrity and publisher of specific image tags.</p>
</li>
</ul>
</div>
</div>
</div>
</li>
<li>
<p>Deployment (CI part of provisioning)</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>The term "Deployment" refers to the process that triggers a deployment in Kubernetes whereas a Kubernetes deployment refers to the Kubernets deployment resource. A kubernetes deployment resource is the standard controller for manipulating pods which in turn host the container workloads.</p>
</div>
<div class="paragraph">
<p>A deployment is triggered by the provisioning pipeline.  Depending on the scope a deployment goes beyond the a kubernetes deployment that results in a Kubernetes deployment resource. The various steps across various scenarios can be generalized as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pre-Kubernetes Deployment steps</p>
</li>
<li>
<p>Kubernetes Deployment
Azure provisioning services provide ways to trigger with native kubernetes means such as manifests by supporting special tasks/ activties. However, this results in quite a number of files you have to maintain. Additional tools like <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/deploy/helm-deploy?view=azure-devops">helm</a> (see variation) provide better support.</p>
</li>
<li>
<p>Post-Kubernetes Deployment steps</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The most complex deployment scenario is a rolling update with breaking database changes. In that case pre and post Kubernetes deployment steps are required to <a href="https://stackoverflow.com/questions/48877182/kubernetes-rolling-deployments-and-database-migrations/48880687">handle the breaking database changes</a>. Such an update requires targeting specific components e.g. with a certain version. Labels are key/value pairs that are attached to objects, such as pods. They help in filtering out specific objects. Using a Selector, the client/user can identify a set of objects. Annotations are used to attach arbitrary non-identifying metadata to objects.</p>
</div>
<div class="paragraph">
<p>The basic idea is to break down the breaking database change into multiple non-breaking steps. The <a href="https://stackoverflow.com/questions/48877182/kubernetes-rolling-deployments-and-database-migrations/48880687">steps below</a> refer to a renaming of a column:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add a db migration that inserts the new column</p>
</li>
<li>
<p>Change the app so that all writes go to the old and new column</p>
</li>
<li>
<p>Run a task that copies all values from the old to the new column</p>
</li>
<li>
<p>Change the app that it reads from the new column</p>
</li>
<li>
<p>Add a migration that remove the old column</p>
</li>
</ol>
</div>
</div>
</div>
</li>
<li>
<p>Monitoring</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Application logs can help in understanding the activities and status of the application. The logs are particularly useful for debugging problems and monitoring cluster activity. Monitoring applications can be done by storing logs and studying the application’s metrics.</p>
</div>
<div class="paragraph">
<p>Tools like Prometheus-Grafana are popular as they make the management of metrics very easy. Very often, sidecar containers are used as metrics exporters of the main application container.</p>
</div>
<div class="paragraph">
<p>By <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/containers/container-insights-prometheus-integration">integrating with Azure Monitor</a>, a Prometheus server is not required. You just need to expose the Prometheus metrics endpoint through your exporters or pods (application), and the containerized agent for Container insights can scrape the metrics for you.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="mon_cnt_insights.png" alt="Monitoring Container Insights" width="1706" height="632">
</div>
</div>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="index.asciidoc_variations">Variations</h4>
<div class="paragraph">
<p>The following additional extra tools can be used in conjunction with Kubernetes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Deployment</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>Instead of having to write separate YAML files for each application manually, you can simply create a Helm chart and let Helm deploy the application to the cluster for you. Helm charts contain templates for various Kubernetes resources that combine to form an application.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="helm_chart_example.png" alt="Helm chart example">
</div>
</div>
<div class="paragraph">
<p>A Helm chart can be customized when deploying it on different Kubernetes clusters. Helm charts can be created in such a way that environment or deployment-specific configurations can be extracted out to a separate file so that these values can be specified when the Helm chart is deployed. The snippet below shows a template using placeholders to refer to the values in values.yaml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="YAML language-YAML">apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Values.postgres.name }}
  labels:
    app: {{ .Values.postgres.name }}
    group: {{ .Values.postgres.group }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app: {{ .Values.postgres.name }}
      ...</code></pre>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Compliance</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>For security reasons and improvement of Helm charts, it is useful to make use of at least one Helm linting tool to ensure your deployments are valid and versioned correctly.</p>
</div>
<div class="paragraph">
<p>Why choosing Polaris as Linting Tool: For helm chart linting, there are several tools like Polaris, kube-score or config-lint available. With Polaris, checks and rules are already given by default, whereby other tools need a lot of custom rules configuration and are therefore more complex to setup. Polaris runs a variety of checks to ensure that Kubernetes pods and controllers are configured using best practices, helping to avoid problems in the future. Polaris can be either installed inside a cluster or as a command-line tool to analyze Kubernetes manifests statically.</p>
</div>
</div>
</div>
</li>
<li>
<p>Configuration</p>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>See under infrastructure.</p>
</div>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="index.asciidoc_when-to-use">When to use</h4>
<div class="paragraph">
<p>When you want to deploy containerized applications to Azure Kubernetes Service.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="index.asciidoc_credits">Credits</h2>
<div class="sectionbody">
<div class="imageblock" style="text-align: right;">
<div class="content">
<a class="image" href="https://forms.office.com/Pages/ResponsePage.aspx?id=Wq6idgCfa0-V7V0z13xNYal7m2EdcFdNsyBBMUiro4NUNllHQTlPNU9QV1JRRjk3TTAwVUJCNThTRSQlQCN0PWcu"><img src="ms_guild_logo.png" alt="MS Guild Logo" width="160" height="75"></a>
</div>
</div>
</div>
</div>
</div>
<div id="footer" class="footer">
<div class="openblock footerLinks">
<div class="content">
<div class="dlist linklist">
<dl>
<dt class="hdlist1">About</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="/website/pages/welcome/welcome.html">About devonfw</a></p>
</li>
<li>
<p><a href="/website/pages/docs/devonfw-guide_getting-started.wiki_introduction-why-should-i-use-devonfw.asciidoc_features.html">Features</a></p>
</li>
<li>
<p><a href="/website/pages/docs/devonfw-guide_devon4j.wiki_architecture.asciidoc.html#devonfw-guide_devon4j.wiki_architecture.asciidoc_technology-stack#">Technology Stack</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist linklist">
<dl>
<dt class="hdlist1">Explore</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="/website/pages/docs/devonfw-guide_getting-started.wiki_getting-started.asciidoc.html">Getting started</a></p>
</li>
<li>
<p><a href="/website/pages/docs/devonfw-guide_devon4j.wiki_architecture.asciidoc.html">Architecture</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist linklist">
<dl>
<dt class="hdlist1">Docs</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="/website/pages/docs/devonfw-guide_ide.wiki_devonfw-ide-introduction.asciidoc.html">User guide</a></p>
</li>
<li>
<p><a href="/website/pages/docs/devonfw-guide_general_master-release-notes.asciidoc.html">Releases information</a></p>
</li>
<li>
<p><a href="/website/pages/docs/master.html">Wiki</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist linklist">
<dl>
<dt class="hdlist1">Community</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/orgs/devonfw/people">Contributors</a></p>
</li>
<li>
<p><a href="https://github.com/devonfw/devonfw.github.io/blob/develop/README.asciidoc">Website Contribution</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="ulist footerFooter">
<ul>
<li>
<p><a href="https://devonfw.com/website/pages/docs/devonfw-guide_ide.wiki_LICENSE.asciidoc.html">Terms of Use</a></p>
</li>
<li>
<p><a href="https://github.com/devonfw">Support</a></p>
</li>
</ul>
</div>
</div>
    <script>
      let bb = document.getElementById('menu-button');
      bb.addEventListener('click', function() {
        document.querySelector('.website-navbar ul').classList.toggle('visible');
        console.log(document.querySelector('.website-navbar ul'))
      })
    </script>
    <script type="module">
      import { EditLinksModule } from '/website/shared/editlinks.js';

      let alwaysVisible = true;
      if(document.location.pathname.endsWith("pages/welcome/welcome.html")) {
        alwaysVisible = false;
      }
      EditLinksModule.addEditLinks(alwaysVisible);
    </script>
    <script src="/website/assets/scripts/popper.min.js"></script>
    <script src="/website/assets/scripts/bootstrap.min.js"></script>
<div class="footnote"><sub>

Last updated 2022-06-23 12:04:37 UTC
</sub></div>
</div>

<link rel="stylesheet" type="text/css" href="https://cginternal.devonfw.com/websitesnippets/main.css">
<script async="" src="https://cginternal.devonfw.com/websitesnippets/main.js"></script>
<script>
  if(!document.location.pathname.endsWith("pages/welcome/welcome.html")) {
    anchors.options.visible = 'always';
  }
  anchors.add();
</script>
<script>
  var internalUrls = ["https://cginternal.devonfw.com/websitesnippets/"];
  $(".internal").each(function(){
    internalUrls.forEach((internalUrl, index) => {
      $.ajax({url: internalUrl + $(this).text() + "/index.html" })
      .then(r => {
        var leftDiv = $('<div class="info"><span class="infoText">Internal</span><img class="infoImage" src="' + internalUrl + 'logo.png"/></div>');
        var rightFirstDiv = $('<div class="message">This is only visible inside of the corporate network.</div>');
        var rightLastDiv = $('<div class="content"></div>');
        rightLastDiv.html(r);
        var rightDiv = $('<div class="right"></div>');
        rightDiv.append(rightFirstDiv);
        rightDiv.append(rightLastDiv);
        $(this).html(leftDiv);
        $(this).append(rightDiv);
        $(this).addClass("internal-active");
        $(this).removeClass("internal");
      })
    });
	});
</script>
<script>
      let cookieName = 'cookie_consent';
      let expiryTime = new Date(2037, 11, 21);
      let today = new Date();
      let cookieConsentDeclinedDate = localStorage.getItem("cookie_consent_declined");
      let dateDiffHours = 0;
      let cookieConsentHtml = `
      <div id="cookie-consent">
        <p>
          We use cookies to perform analytics and enhance user experience. Do you accept to the use of cookies?
        </p>
        <p class="cookie-consent-buttons">
          <a id="decline-cookie-btn" class="btn white-button" href="javascript:void(0)">Decline</a>
          <a id="accept-cookie-btn" class="btn blue-button" href="javascript:void(0)">Accept</a>
        </p>
      </div>
      `;
      dateDiffHours = cookieConsentDeclinedDate ? Math.abs(cookieConsentDeclinedDate - today) / 36e5 : 0;
      if (document.cookie.indexOf(cookieName) < 0) {
        if (cookieConsentDeclinedDate) {
          if (dateDiffHours > 24) {
            $("body").append(cookieConsentHtml);
          }
        } else {
          $("body").append(cookieConsentHtml);
        }
      }
      $("#accept-cookie-btn").click(function() {
        document.cookie = `${cookieName}=accept;expires=${expiryTime};path=/`;
        localStorage.removeItem("cookie_consent_declined");
        consentGranted();
        $("#cookie-consent").hide();
      });
      $("#decline-cookie-btn").click(function() {
        localStorage.setItem("cookie_consent_declined", today);
        $("#cookie-consent").hide();
      });
</script>

</body></html>