<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=">
<meta name="generator" content="Asciidoctor 1.5.8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ******** SOCIAL MEDIA META ********** -->

<meta name="title" property="og:title" content="devonfw website">
<meta property="og:type" content="website">
<meta name="image" property="og:image" content="https://devonfw.com/images/devonfwwebsite.png">
<meta name="description" property="og:description" content="devonfw is the standard open source software development platform; Serving the full Software Delivery Life Cycle.">
<meta property="og:url" content="https://devonfw.com/index.html">

<meta name="twitter:title" content="devonfw website">
<meta name="twitter:description" content="devonfw is the standard open source software development platform; Serving the full Software Delivery Life Cycle.">
<meta name="twitter:image" content="https://devonfw.com/images/devonfwwebsite.png">
<meta name="twitter:card" content="summary_large_image">

<!-- ************************************* -->


<title>Publishing the MyThaiStar Application</title>
<!-- devonfw website stylesheet -->
<link rel="stylesheet" type="text/css" href="/devonfw.css">
<!-- Lunr -->
<script src="/website/assets/scripts/lunr.min.js"></script>
<!-- JQuery -->
<script src="/website/assets/scripts/jquery.min.js"></script>
<link rel="stylesheet" href="/website/assets/styles/font-awesome.min.css">
<link rel="stylesheet" href="/website/assets/styles/googlecode.min.css">
<script src="/website/assets/scripts/highlight.min.js"></script>
<script src="/website/assets/scripts/common.min.js"></script>
<script>hljs.initHighlightingOnLoad()</script>
<link rel="stylesheet" href="/website/assets/styles/bootstrap.min.css">

<script src="/website/assets/scripts/anchor.min.js"></script>

<script src="/website/components/header/search-engine/bundle.js"></script>

<script src="/website/shared/rightmenu.js"></script>

<!-- ************** Google analytics ************ -->
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}

gtag('consent', 'default', {
  'analytics_storage': 'denied'
});
</script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-151636804-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-151636804-1');
</script>
<script>
  function consentGranted() {
    gtag('consent', 'update', {
      'analytics_storage': 'granted'
    });
  }
</script>

<!-- ******************************************** -->


</head>
<body class="article">
<div id="website-navbar" class="website-navbar">
<button id="menu-button" class="menu-button">
  <img src="/images/menu-button.svg" width="32px" height="32px" alt=""/>
</button>

<ul>
<li>
<p><span class="image"><a class="image" href="/website/pages/welcome/welcome.html"><img alt="logo" src="/images/Logo_devonfw.svg"></a></span></p>
</li>
<li>
<p><a href="https://killercoda.com/devonfw">Tutorials</a></p>
</li>
<li>
<p><a href="/website/pages/solutions/index.html">Solutions</a></p>
</li>
<li>
<p><a href="/website/pages/docs/master.html">Docs</a></p>
</li>
</ul>

<form class="form-inline">
  <div class="search-bar">
    <input
      id="search-field"
      type="search"
      class="form-control mr-sm-2"
      placeholder="Search by keyword(s)..."
      aria-label="Search"
      style="height: auto;"
      autocomplete="off"/>
    <div class="sb-res-pos px-4">
      <div id="click-outside" class="click-outside z-50 hidden"></div>
      <div class="col rounded px-0 border z-100 bg-white hidden search-bar-results" id="search-results-box">
      </div>
    </div>
  </div>
</form>
<a class="navbar-github text-white" href="https://github.com/devonfw/">
  <img src="/images/github-mark.png" width=auto height=auto alt="">
</a></div>
<div id="sidebar" class="wiki-sidebar"></div>

<div id="content" class="mt-4 mt-sm-5">
<div class="toc2">
<div class="title">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#devonfw-guide_my-thai-star.wiki_my-thai-star-publish.asciidoc">Publishing the <code>MyThaiStar</code> Application</a>
<ul class="sectlevel1">
<li><a href="#devonfw-guide_my-thai-star.wiki_my-thai-star-publish.asciidoc_production-line-instance">Production Line Instance</a></li>
<li><a href="#devonfw-guide_my-thai-star.wiki_my-thai-star-publish.asciidoc_pipeline-script">Pipeline Script</a>
<ul class="sectlevel2">
<li><a href="#devonfw-guide_my-thai-star.wiki_my-thai-star-publish.asciidoc_complete-pipeline-script">Complete Pipeline Script:</a></li>
</ul>
</li>
<li><a href="#devonfw-guide_my-thai-star.wiki_my-thai-star-publish.asciidoc_accessing-mythaistar">Accessing <code>MyThaiStar</code></a></li>
<li><a href="#devonfw-guide_my-thai-star.wiki_my-thai-star-publish.asciidoc_notes">Notes</a></li>
</ul>
</li>
</ul>
<h1 id="devonfw-guide_my-thai-star.wiki_my-thai-star-publish.asciidoc" class="sect0">Publishing the <code>MyThaiStar</code> Application</h1>
<div class="paragraph">
<p>This page will explain how to build and deploy the application.</p>
</div>
<div class="sect1">
<h2 id="devonfw-guide_my-thai-star.wiki_my-thai-star-publish.asciidoc_production-line-instance">Production Line Instance</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Production Line instance being used can be found <a href="https://devon.s2-eu.capgemini.com">here</a>. After logging in you&#8217;ll see a list of existing jobs and pipelines.
However, only a folder is relevant to this topic: <strong>MTS</strong></p>
</div>
<div class="paragraph">
<p><strong>Note</strong>: A user account is required for authentication. Contact a devon team member to request a new account.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="devonfw-guide_my-thai-star.wiki_my-thai-star-publish.asciidoc_pipeline-script">Pipeline Script</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ll have a closer look at the pipeline configuration script and its stages:</p>
</div>
<div class="paragraph">
<p><strong>Note</strong>: Have a look at this wiki over <code><a href="https://github.com/devonfw/devon-ci/wiki/guide-devonci-jenkins-pipeline">here</a></code> to get a basic idea on how to write pipeline scripts.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Checking out MyThaiStar form GitHub</p>
<div class="paragraph">
<p>This stage will check out the source code directly from GitHub:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="groovy language-groovy">git credentialsId:'github-devonfw-ci', url:'https://github.com/devonfw/my-thai-star/'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Credentials are required for authentication as we&#8217;re checking out a private repository. <code>'github-devonfw-ci'</code> is a pair of credentials that was created for this sole purpose.</p>
</div>
</li>
<li>
<p>Loading custom tools</p>
<div class="paragraph">
<p>To build the application, two tools are required: Node 6 and Angular CLI.</p>
</div>
<div class="paragraph">
<p>They just have to be referenced, as the Custom Tool Plugin will handle the installation process:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="groovy language-groovy">tool 'Node 6'
tool 'Angular CLI'</code></pre>
</div>
</div>
</li>
<li>
<p>Fresh Dependency installation
To ensure that we get fresh dependencies, we&#8217;ll have to make sure that our dependencies folder <em>node_modules</em> is removed and the installation process is run again.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="groovy language-groovy">find . -name "node_modules" -exec rm -rf '{}' +
npm i</code></pre>
</div>
</div>
</li>
<li>
<p>Code Linting</p>
<div class="paragraph">
<p>By "linting" our Angular code we check the quality of the code. TypeScript provides a useful tool for that. It is call <strong>TSLint</strong>. This process is triggered via Angular CLI.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="groovy language-groovy">ng lint --format checkstyle</code></pre>
</div>
</div>
</li>
<li>
<p>Execute Unit Tests</p>
<div class="paragraph">
<p>By default, Angular tests are executed using the Chrome browser. That can be a problem when they need to be executed in a CI environment, such as Jenkins (which is the case) or Travis. Angular projects can be prepared to deal with it, using the PhantomJS browser instead of chrome.</p>
</div>
<div class="paragraph">
<p>We can prepare a script for that in our <code>package.json</code> file, or we can directly write it in the command line. Also, it is necessary to make sure that those test will just executed once, because by default it will be watching for changes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="groovy language-groovy">ng test --browsers PhantomJS --single-run</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="groovy language-groovy">yarn test:ci</code></pre>
</div>
</div>
</li>
<li>
<p>Build application</p>
<div class="paragraph">
<p>The building process needs to be sufficiently flexible to be adapted for different deployments. As long as the My Thai Star Angular client needs (or <em>will need</em>) to point to different servers (devon4j, Node and .NET), it is mandatory to have the chance to separately "prepare" the artifact for all of them.</p>
</div>
<div class="paragraph">
<p>What does that mean? There are some files dedicated to those situations. They&#8217;re called <em>environment</em>. They&#8217;ll define some data to be used under different circumstances.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="groovy language-groovy">ng build --aot --environment=prod</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="groovy language-groovy">yarn build:prod</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>ng build</em> command creates a <em>dist</em> folder which contains the application.</p>
</div>
</li>
<li>
<p>Deployment</p>
<div class="paragraph">
<p>The deployment step has to be approved by a human. Otherwise it won&#8217;t proceed.</p>
</div>
<div class="paragraph">
<p>The user can decide on whether to proceed and deploy the application or to abort and just keep the generated files inside the <em>dist</em> directory.</p>
</div>
<div class="paragraph">
<p>After clicking on proceed, the following lines will be executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="groovy language-groovy"># Change to Angular directory
cd angular

# Copy "dist" folder from workspace to deployment server
scp -o StrictHostKeyChecking=no -r dist root@10.40.235.244:/root/mythaistar/

# Launch application in Docker container
ssh -o StrictHostKeyChecking=no root@10.40.235.244 docker rm -f mythaistar
ssh -o StrictHostKeyChecking=no root@10.40.235.244 docker run -itd --name=mythaistar -p 8090:80 nginx
ssh -o StrictHostKeyChecking=no root@10.40.235.244 docker exec mythaistar bash -c \\"rm /usr/share/nginx/html/*\\"
ssh -o StrictHostKeyChecking=no root@10.40.235.244 docker cp mythaistar/dist/. mythaistar:/usr/share/nginx/html/</code></pre>
</div>
</div>
<div class="paragraph">
<p>After deploying the application will be available at <a href="http://de-mucdevondepl01:8090">http://de-mucdevondepl01:8090</a></p>
</div>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="devonfw-guide_my-thai-star.wiki_my-thai-star-publish.asciidoc_complete-pipeline-script">Complete Pipeline Script:</h3>
<div class="paragraph">
<p>The complete Groovy script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="groovy language-groovy">node {
    stage 'Checking out my-thai-star from GitHub'
        node {
            git branch: 'develop', credentialsId: 'github-devonfw-ci', url: 'https://github.com/devonfw/my-thai-star/'
        }

    stage 'Loading Custom Tools'
        node {
            tool 'Node 6'
            tool 'Angular CLI'
        }

    stage 'Fresh Dependency Installation'
        node {
            sh """
                cd angular
                find . -name "node_modules" -exec rm -rf '{}' +
                npm i
            """
        }

    stage 'Code Linting'
        node {
            sh """
                cd angular
                ng lint --format checkstyle
            """
        }

    stage 'Execute Angular tests'
        node {
            sh """
                cd angular
                ng test --browsers PhantomJS --single-run
            """
        }

    stage 'Build Application'
        node {
            sh """
                cd angular
                ng build --aot --prod
            """
        }

    stage 'Deployment'
        input 'Should this build be deployed?'
            node {
                sshagent (credentials: ['3d0fa2a4-5cf0-4cf5-a3fd-23655eb33c11']) {
                    sh """
                        cd angular
                        # Copy resulting "dist" folder from workspace to deployment server
                        scp -o StrictHostKeyChecking=no -r dist root@10.40.235.244:/root/mythaistar/

                        # Launch application in Docker container
                        ssh -o StrictHostKeyChecking=no root@10.40.235.244 docker rm -f mythaistar
                        ssh -o StrictHostKeyChecking=no root@10.40.235.244 docker run -itd --name=mythaistar -p 8090:80 nginx
                        ssh -o StrictHostKeyChecking=no root@10.40.235.244 docker exec mythaistar bash -c \\"rm /usr/share/nginx/html/*\\"
                        ssh -o StrictHostKeyChecking=no root@10.40.235.244 docker cp mythaistar/dist/. mythaistar:/usr/share/nginx/html/

                    """
                }
                sh 'echo \\"Application available at http://de-mucdevondepl01:8090\\"'
            }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="devonfw-guide_my-thai-star.wiki_my-thai-star-publish.asciidoc_accessing-mythaistar">Accessing <code>MyThaiStar</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Finally, the application will be available at this URL: <a href="http://de-mucdevondepl01:8090">http://de-mucdevondepl01:8090</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="devonfw-guide_my-thai-star.wiki_my-thai-star-publish.asciidoc_notes">Notes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Make sure not to launch multiple instances of this pipeline in parallel. While a pipeline is waiting for approval it&#8217;ll still be blocking a build executor.
This PL instance is set up to have <strong>two</strong> build executors.</p>
</div>
<div class="paragraph">
<p>This means: When launching this pipeline two times in parallel without approving the build, other jobs/pipeline won&#8217;t be able
to run properly.</p>
</div>
</div>
</div>
</div>
<div id="footer" class="footer">
<div class="openblock footerLinks">
<div class="content">
<div class="dlist linklist">
<dl>
<dt class="hdlist1">About</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="/website/pages/welcome/welcome.html">About devonfw</a></p>
</li>
<li>
<p><a href="/website/pages/docs/devonfw-guide_getting-started.wiki_introduction-why-should-i-use-devonfw.asciidoc_features.html">Features</a></p>
</li>
<li>
<p><a href="/website/pages/docs/devonfw-guide_devon4j.wiki_architecture.asciidoc.html#devonfw-guide_devon4j.wiki_architecture.asciidoc_technology-stack">Technology Stack</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist linklist">
<dl>
<dt class="hdlist1">Explore</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="/website/pages/docs/devonfw-guide_getting-started.wiki_getting-started.asciidoc.html">Getting started</a></p>
</li>
<li>
<p><a href="/website/pages/docs/devonfw-guide_devon4j.wiki_architecture.asciidoc.html">Architecture</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist linklist">
<dl>
<dt class="hdlist1">Docs</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="/website/pages/docs/devonfw-guide_ide.wiki_devonfw-ide-introduction.asciidoc.html">User guide</a></p>
</li>
<li>
<p><a href="/website/pages/docs/devonfw-guide_general_master-release-notes.asciidoc.html">Releases information</a></p>
</li>
<li>
<p><a href="/website/pages/docs/master.html">Wiki</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist linklist">
<dl>
<dt class="hdlist1">Community</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/orgs/devonfw/people">Contributors</a></p>
</li>
<li>
<p><a href="https://github.com/devonfw/devonfw.github.io/blob/develop/README.asciidoc">Website Contribution</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="ulist footerFooter">
<ul>
<li>
<p><a href="https://devonfw.com/website/pages/docs/devonfw-guide_ide.wiki_LICENSE.asciidoc.html">Terms of Use</a></p>
</li>
<li>
<p><a href="https://github.com/devonfw">Support</a></p>
</li>
</ul>
</div>
</div>
    <script>
      let bb = document.getElementById('menu-button');
      bb.addEventListener('click', function() {
        document.querySelector('.website-navbar ul').classList.toggle('visible');
        console.log(document.querySelector('.website-navbar ul'))
      })
    </script>
    <script type="module">
      import { EditLinksModule } from '/website/shared/editlinks.js';

      let alwaysVisible = true;
      if(document.location.pathname.endsWith("pages/welcome/welcome.html")) {
        alwaysVisible = false;
      }
      EditLinksModule.addEditLinks(alwaysVisible);
    </script>
    <script src="/website/assets/scripts/popper.min.js"></script>
    <script src="/website/assets/scripts/bootstrap.min.js"></script>
<div class="footnote"><sub>

Last updated 2022-06-29 08:31:06 UTC
</sub></div>
</div>
</div>
<link rel="stylesheet" type="text/css" href="https://cginternal.devonfw.com/websitesnippets/main.css">
<script async src="https://cginternal.devonfw.com/websitesnippets/main.js"></script>
<script>
  if(!document.location.pathname.endsWith("pages/welcome/welcome.html")) {
    anchors.options.visible = 'always';
  }
  anchors.add();
</script>
<script>
  var internalUrls = ["https://cginternal.devonfw.com/websitesnippets/"];
  $(".internal").each(function(){
    internalUrls.forEach((internalUrl, index) => {
      $.ajax({url: internalUrl + $(this).text() + "/index.html" })
      .then(r => {
        var leftDiv = $('<div class="info"><span class="infoText">Internal</span><img class="infoImage" src="' + internalUrl + 'logo.png"/></div>');
        var rightFirstDiv = $('<div class="message">This is only visible inside of the corporate network.</div>');
        var rightLastDiv = $('<div class="content"></div>');
        rightLastDiv.html(r);
        var rightDiv = $('<div class="right"></div>');
        rightDiv.append(rightFirstDiv);
        rightDiv.append(rightLastDiv);
        $(this).html(leftDiv);
        $(this).append(rightDiv);
        $(this).addClass("internal-active");
        $(this).removeClass("internal");
      })
    });
	});
</script>
<script>
      let cookieName = 'cookie_consent';
      let expiryTime = new Date(2037, 11, 21);
      let today = new Date();
      let cookieConsentDeclinedDate = localStorage.getItem("cookie_consent_declined");
      let dateDiffHours = 0;
      let cookieConsentHtml = `
      <div id="cookie-consent">
        <p>
          We use cookies to perform analytics and enhance user experience. Do you accept to the use of cookies?
        </p>
        <p class="cookie-consent-buttons">
          <a id="decline-cookie-btn" class="btn white-button" href="javascript:void(0)">Decline</a>
          <a id="accept-cookie-btn" class="btn blue-button" href="javascript:void(0)">Accept</a>
        </p>
      </div>
      `;
      dateDiffHours = cookieConsentDeclinedDate ? Math.abs(cookieConsentDeclinedDate - today) / 36e5 : 0;
      if (document.cookie.indexOf(cookieName) < 0) {
        if (cookieConsentDeclinedDate) {
          if (dateDiffHours > 24) {
            $("body").append(cookieConsentHtml);
          }
        } else {
          $("body").append(cookieConsentHtml);
        }
      }
      $("#accept-cookie-btn").click(function() {
        document.cookie = `${cookieName}=accept;expires=${expiryTime};path=/`;
        localStorage.removeItem("cookie_consent_declined");
        consentGranted();
        $("#cookie-consent").hide();
      });
      $("#decline-cookie-btn").click(function() {
        localStorage.setItem("cookie_consent_declined", today);
        $("#cookie-consent").hide();
      });
</script>
</body>
</html>