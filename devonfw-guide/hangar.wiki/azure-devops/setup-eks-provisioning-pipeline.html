<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=">
<meta name="generator" content="Asciidoctor 1.5.8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ******** SOCIAL MEDIA META ********** -->

<meta name="title" property="og:title" content="devonfw website">
<meta property="og:type" content="website">
<meta name="image" property="og:image" content="https://devonfw.com/images/devonfwwebsite.png">
<meta name="description" property="og:description" content="devonfw is the standard open source software development platform; Serving the full Software Delivery Life Cycle.">
<meta property="og:url" content="https://devonfw.com/index.html">

<meta name="twitter:title" content="devonfw website">
<meta name="twitter:description" content="devonfw is the standard open source software development platform; Serving the full Software Delivery Life Cycle.">
<meta name="twitter:image" content="https://devonfw.com/images/devonfwwebsite.png">
<meta name="twitter:card" content="summary_large_image">

<!-- ************************************* -->


<title>Setting up a AWS EKS provisioning pipeline on Azure DevOps</title>
<!-- devonfw website stylesheet -->
<link rel="stylesheet" type="text/css" href="/devonfw.css">
<!-- Lunr -->
<script src="/website/assets/scripts/lunr.min.js"></script>
<!-- JQuery -->
<script src="/website/assets/scripts/jquery.min.js"></script>
<link rel="stylesheet" href="/website/assets/styles/font-awesome.min.css">
<link rel="stylesheet" href="/website/assets/styles/googlecode.min.css">
<script src="/website/assets/scripts/highlight.min.js"></script>
<script src="/website/assets/scripts/common.min.js"></script>
<script>hljs.initHighlightingOnLoad()</script>
<link rel="stylesheet" href="/website/assets/styles/bootstrap.min.css">

<script src="/website/assets/scripts/anchor.min.js"></script>

<script src="/website/components/header/search-engine/bundle.js"></script>

<script src="/website/shared/rightmenu.js"></script>

<!-- ************** Google analytics ************ -->
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}

gtag('consent', 'default', {
  'analytics_storage': 'denied'
});
</script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-151636804-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-151636804-1');
</script>
<script>
  function consentGranted() {
    gtag('consent', 'update', {
      'analytics_storage': 'granted'
    });
  }
</script>

<!-- ******************************************** -->


</head>
<body class="article">
<div id="website-navbar" class="website-navbar">
<button id="menu-button" class="menu-button">
  <img src="/images/menu-button.svg" width="32px" height="32px" alt=""/>
</button>

<ul>
<li>
<p><span class="image"><a class="image" href="/website/pages/welcome/welcome.html"><img alt="logo" src="/images/Logo_devonfw.svg"></a></span></p>
</li>
<li>
<p><a href="https://devonfw.com/website/pages/learning/">Tutorials</a></p>
</li>
<li>
<p><a href="/website/pages/solutions/index.html">Solutions</a></p>
</li>
<li>
<p><a href="/website/pages/docs/master.html">Docs</a></p>
</li>
</ul>

<form class="form-inline">
  <div class="search-bar">
    <input
      id="search-field"
      type="search"
      class="form-control mr-sm-2"
      placeholder="Search by keyword(s)..."
      aria-label="Search"
      style="height: auto;"
      autocomplete="off"/>
    <div class="sb-res-pos px-4">
      <div id="click-outside" class="click-outside z-50 hidden"></div>
      <div class="col rounded px-0 border z-100 bg-white hidden search-bar-results" id="search-results-box">
      </div>
    </div>
  </div>
</form>
<a class="navbar-github text-white" href="https://github.com/devonfw/">
  <img src="/images/github-mark.png" width=auto height=auto alt="">
</a></div>
<div id="sidebar" class="wiki-sidebar"></div>

<div id="content" class="mt-4 mt-sm-5">
<div class="toc2">
<div class="title">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#devonfw-guide_hangar.wiki_azure-devops_setup-eks-provisioning-pipeline.asciidoc">Setting up a AWS EKS provisioning pipeline on Azure DevOps</a>
<ul class="sectlevel2">
<li><a href="#devonfw-guide_hangar.wiki_azure-devops_setup-eks-provisioning-pipeline.asciidoc_prerequisites">Prerequisites</a></li>
<li><a href="#devonfw-guide_hangar.wiki_azure-devops_setup-eks-provisioning-pipeline.asciidoc_creating-the-pipeline-using-provided-script">Creating the pipeline using provided script</a>
<ul class="sectlevel2">
<li><a href="#devonfw-guide_hangar.wiki_azure-devops_setup-eks-provisioning-pipeline.asciidoc_usage">Usage</a></li>
<li><a href="#devonfw-guide_hangar.wiki_azure-devops_setup-eks-provisioning-pipeline.asciidoc_flags">Flags</a></li>
<li><a href="#devonfw-guide_hangar.wiki_azure-devops_setup-eks-provisioning-pipeline.asciidoc_example">Example</a></li>
</ul>
</li>
<li><a href="#devonfw-guide_hangar.wiki_azure-devops_setup-eks-provisioning-pipeline.asciidoc_appendix-interacting-with-the-cluster">Appendix: Interacting with the cluster</a></li>
<li><a href="#devonfw-guide_hangar.wiki_azure-devops_setup-eks-provisioning-pipeline.asciidoc_appendix-destroying-the-cluster">Appendix: Destroying the cluster</a></li>
<li><a href="#devonfw-guide_hangar.wiki_azure-devops_setup-eks-provisioning-pipeline.asciidoc_appendix-rancher-resources">Appendix: Rancher resources</a></li>
</ul>
</li>
</ul>
<h1 id="devonfw-guide_hangar.wiki_azure-devops_setup-eks-provisioning-pipeline.asciidoc" class="sect0">Setting up a AWS EKS provisioning pipeline on Azure DevOps</h1>
<div class="paragraph">
<p>In this section we will create a pipeline which will provision an AWS EKS cluster. This pipeline will be configured to be manually triggered by the user. As part of EKS cluster provisioning, a NGINX Ingress controller is deployed and a variable group with the name <code>eks-variables</code> is created, which contains, among others, the DNS name of the Ingress controller, that you you will need to add as CNAME record on the domains used in your application Ingress manifest files. Refer to the appendix to retrieve the DNS name of the Ingress controller independently.</p>
</div>
<div class="paragraph">
<p>The creation of the pipeline will follow the project workflow, so a new branch named <code>feature/eks-provisioning</code> will be created, the YAML file for the pipeline and the terraform files for creating the cluster will be pushed to it.</p>
</div>
<div class="paragraph">
<p>Then, a Pull Request (PR) will be created in order to merge the new branch into the appropiate branch (provided in <code>-b</code> flag). The PR will be automatically merged if the repository policies are met. If the merge is not possible, either the PR URL will be shown as output, or it will be opened in your web browser if using <code>-w</code> flag.</p>
</div>
<div class="paragraph">
<p>The script located at <code>/scripts/pipelines/azure-devops/pipeline_generator.sh</code> will automatically create this new branch, create the EKS provisioning pipeline based on the YAML template, create the Pull Request and, if it is possible, merge this new branch into the specified branch.</p>
</div>
<div class="sect2">
<h3 id="devonfw-guide_hangar.wiki_azure-devops_setup-eks-provisioning-pipeline.asciidoc_prerequisites">Prerequisites</h3>
<div class="ulist">
<ul>
<li>
<p>Install the <a href="https://marketplace.visualstudio.com/items?itemName=ms-devlabs.custom-terraform-tasks">Terraform extension</a> for Azure DevOps.</p>
</li>
<li>
<p>Create a service connection for connecting to an AWS account (as explained in the above Terraform extension link) and name it <code>AWS-Terraform-Connection</code>. If you already have a service connection available or you need a specific connection name, please update <code>eks-pipeline.cfg</code> accordingly.</p>
</li>
<li>
<p>A S3 Bucket. You can use an existing one or <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-services-s3-commands.html#using-s3-commands-managing-buckets-creating">create a new one</a> with the following command:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>aws s3 mb &lt;bucket name&gt;
# Example: aws s3 mb s3://terraform-state-bucket</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>An AWS IAM user with <a href="https://github.com/devonfw/hangar/blob/master/documentation/aws/setup-aws-account-iam-for-eks.asciidoc#check-iam-user-permissions">required permissions</a> to provision the EKS cluster.</p>
</li>
<li>
<p>This script will commit and push the corresponding YAML template into your repository, so please be sure your local repository is up-to-date (i.e you have pulled the latest changes with <code>git pull</code>).</p>
</li>
</ul>
</div>
</div>
<div class="sect1">
<h2 id="devonfw-guide_hangar.wiki_azure-devops_setup-eks-provisioning-pipeline.asciidoc_creating-the-pipeline-using-provided-script">Creating the pipeline using provided script</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before executing the pipeline generator, you will need to customize some input variables about the environment. Also, you may want to use existing VPC and subnets instead of creating new ones. To do so, you can either edit <code>terraform.tfvars</code> file or take advantage of the <code>set-terraform-variables.sh</code> script located at <code>/scripts/environment-provisioning/aws/eks</code>, which allows you to create or update values for the required variables, passing them as flags.</p>
</div>
<div class="paragraph">
<p>Example: creating a new VPC on cluster creation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>./set-terraform-variables.sh --region &lt;region name&gt; --instance_type &lt;workers instance type&gt; --vpc_name &lt;vpc name&gt; --vpc_cidr_block &lt;vpc cidr block&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example: reusing existing VPC and subnets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>./set-terraform-variables.sh --region &lt;region name&gt; --instance_type &lt;workers instance type&gt; --existing_vpc_id &lt;vpc id&gt; --existing_vpc_private_subnets &lt;array of subnet ids&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="devonfw-guide_hangar.wiki_azure-devops_setup-eks-provisioning-pipeline.asciidoc_usage">Usage</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>pipeline_generator.sh \
  -c &lt;config file path&gt; \
  -n &lt;pipeline name&gt; \
  -d &lt;project local path&gt; \
  --cluster-name &lt;cluster name&gt; \
  --s3-bucket &lt;s3 bucket name&gt; \
  --s3-key-path &lt;s3 key path&gt; \
  [--aws-access-key &lt;aws access key&gt;] \
  [--aws-secret-access-key &lt;aws secret access key&gt;] \
  [--aws-region &lt;aws region&gt;] \
  [--rancher] \
  [-b &lt;branch&gt;] \
  [-w]</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title=""></i>
</td>
<td class="content">
The config file for the EKS provisioning pipeline is located at <code>/scripts/pipelines/azure-devops/templates/eks/eks-pipeline.cfg</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="devonfw-guide_hangar.wiki_azure-devops_setup-eks-provisioning-pipeline.asciidoc_flags">Flags</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>-c, --config-file               [Required] Configuration file containing pipeline definition.
-n, --pipeline-name             [Required] Name that will be set to the pipeline.
-d, --local-directory           [Required] Local directory of your project (the path should always be using '/' and not '\').
    --cluster-name              [Required] Name for the cluster."
    --s3-bucket                 [Required] Name of the S3 bucket where the Terraform state of the cluster will be stored.
    --s3-key-path               [Required] Path within the S3 bucket where the Terraform state of the cluster will be stored.
    --aws-access-key            [Required, on first run] AWS account access key ID.
    --aws-secret-access-key     [Required, on first run] AWS account secret access key.
    --aws-region                [Required, on first run] AWS region for provisioning resources.
    --rancher                              Install Rancher to manage the cluster.
-b, --target-branch                        Name of the branch to which the Pull Request will target. PR is not created if the flag is not provided.
-w                                         Open the Pull Request on the web browser if it cannot be automatically merged. Requires -b flag.</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="devonfw-guide_hangar.wiki_azure-devops_setup-eks-provisioning-pipeline.asciidoc_example">Example</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>./pipeline_generator.sh -c ./templates/eks/eks-pipeline.cfg -n eks-provisioning -d C:/Users/$USERNAME/Desktop/quarkus-project --cluster-name hangar-eks-cluster --s3-bucket terraform-state-bucket --s3-key-path eks/state --rancher -b develop -w</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title=""></i>
</td>
<td class="content">
Rancher is installed on the cluster after provisioning when using the above command.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="devonfw-guide_hangar.wiki_azure-devops_setup-eks-provisioning-pipeline.asciidoc_appendix-interacting-with-the-cluster">Appendix: Interacting with the cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, generate a <code>kubeconfig</code> file for accessing the AWS EKS cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>aws eks update-kubeconfig --name &lt;cluster name&gt; --region &lt;aws region&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can use <code>kubectl</code> tool to communicate with the cluster.</p>
</div>
<div class="paragraph">
<p>To enable an IAM user to connect to the EKS cluster, please refer <a href="https://docs.aws.amazon.com/eks/latest/userguide/add-user-role.html">here</a>.</p>
</div>
<div class="paragraph">
<p>To get the DNS name of the NGINX Ingress controller on the EKS cluster, run the below command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>kubectl get svc --namespace nginx-ingress nginx-ingress-nginx-ingress-controller -o jsonpath={.status.loadBalancer.ingress[0].hostname}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Rancher, if installed, will be available on <code><a href="https://&lt;ingress" class="bare">https://&lt;ingress</a> controller domain&gt;/dashboard</code>. You will be asked for an initial password, which can be retrieved with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>kubectl get secret --namespace cattle-system bootstrap-secret -o go-template='{{.data.bootstrapPassword|base64decode}}{{"\n"}}'</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="devonfw-guide_hangar.wiki_azure-devops_setup-eks-provisioning-pipeline.asciidoc_appendix-destroying-the-cluster">Appendix: Destroying the cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To destroy the provisioned resources, set <code>operation</code> pipeline variable value to <code>destroy</code> and run the pipeline.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="devonfw-guide_hangar.wiki_azure-devops_setup-eks-provisioning-pipeline.asciidoc_appendix-rancher-resources">Appendix: Rancher resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://rancher.com/docs/rancher/v2.6/en/cluster-admin/cluster-access/kubectl/">Downloading <code>kubeconfig</code></a>.</p>
</li>
<li>
<p><a href="https://rancher.com/docs/rancher/v2.6/en/admin-settings/rbac/">RBAC</a></p>
</li>
<li>
<p><a href="https://rancher.com/docs/rancher/v2.6/en/monitoring-alerting/">Monitoring</a></p>
</li>
<li>
<p><a href="https://rancher.com/docs/rancher/v2.6/en/logging/">Logging</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer" class="footer">
<div class="openblock footerLinks">
<div class="content">
<div class="dlist linklist">
<dl>
<dt class="hdlist1">About</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="/website/pages/welcome/welcome.html">About devonfw</a></p>
</li>
<li>
<p><a href="/website/pages/docs/devonfw-guide_getting-started.wiki_introduction-why-should-i-use-devonfw.asciidoc_features.html">Features</a></p>
</li>
<li>
<p><a href="/website/pages/docs/devonfw-guide_devon4j.wiki_architecture.asciidoc.html#devonfw-guide_devon4j.wiki_architecture.asciidoc_technology-stack">Technology Stack</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist linklist">
<dl>
<dt class="hdlist1">Explore</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="/website/pages/docs/devonfw-guide_getting-started.wiki_getting-started.asciidoc.html">Getting started</a></p>
</li>
<li>
<p><a href="/website/pages/docs/devonfw-guide_devon4j.wiki_architecture.asciidoc.html">Architecture</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist linklist">
<dl>
<dt class="hdlist1">Docs</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="/website/pages/docs/devonfw-guide_ide.wiki_devonfw-ide-introduction.asciidoc.html">User guide</a></p>
</li>
<li>
<p><a href="/website/pages/docs/devonfw-guide_general_master-release-notes.asciidoc.html">Releases information</a></p>
</li>
<li>
<p><a href="/website/pages/docs/master.html">Wiki</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist linklist">
<dl>
<dt class="hdlist1">Community</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/orgs/devonfw/people">Contributors</a></p>
</li>
<li>
<p><a href="https://github.com/devonfw/devonfw.github.io/blob/develop/README.asciidoc">Website Contribution</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="ulist footerFooter">
<ul>
<li>
<p><a href="https://devonfw.com/website/pages/docs/devonfw-guide_ide.wiki_LICENSE.asciidoc.html">Terms of Use</a></p>
</li>
<li>
<p><a href="https://github.com/devonfw">Support</a></p>
</li>
</ul>
</div>
</div>
    <script>
      let bb = document.getElementById('menu-button');
      bb.addEventListener('click', function() {
        document.querySelector('.website-navbar ul').classList.toggle('visible');
        console.log(document.querySelector('.website-navbar ul'))
      })
    </script>
    <script type="module">
      import { EditLinksModule } from '/website/shared/editlinks.js';

      let alwaysVisible = true;
      if(document.location.pathname.endsWith("pages/welcome/welcome.html")) {
        alwaysVisible = false;
      }
      EditLinksModule.addEditLinks(alwaysVisible);
    </script>
    <script src="/website/assets/scripts/popper.min.js"></script>
    <script src="/website/assets/scripts/bootstrap.min.js"></script>
<div class="footnote"><sub>

Last updated 2022-09-12 16:05:53 UTC
</sub></div>
</div>
</div>
<link rel="stylesheet" type="text/css" href="https://cginternal.devonfw.com/websitesnippets/main.css">
<script async src="https://cginternal.devonfw.com/websitesnippets/main.js"></script>
<script>
  if(!document.location.pathname.endsWith("pages/welcome/welcome.html")) {
    anchors.options.visible = 'always';
  }
  anchors.add();
</script>
<script>
  var internalUrls = ["https://cginternal.devonfw.com/websitesnippets/"];
  $(".internal").each(function(){
    internalUrls.forEach((internalUrl, index) => {
      $.ajax({url: internalUrl + $(this).text() + "/index.html" })
      .then(r => {
        var leftDiv = $('<div class="info"><span class="infoText">Internal</span><img class="infoImage" src="' + internalUrl + 'logo.png"/></div>');
        var rightFirstDiv = $('<div class="message">This is only visible inside of the corporate network.</div>');
        var rightLastDiv = $('<div class="content"></div>');
        rightLastDiv.html(r);
        var rightDiv = $('<div class="right"></div>');
        rightDiv.append(rightFirstDiv);
        rightDiv.append(rightLastDiv);
        $(this).html(leftDiv);
        $(this).append(rightDiv);
        $(this).addClass("internal-active");
        $(this).removeClass("internal");
      })
    });
	});
</script>
<script>
      let cookieName = 'cookie_consent';
      let expiryTime = new Date(2037, 11, 21);
      let today = new Date();
      let cookieConsentDeclinedDate = localStorage.getItem("cookie_consent_declined");
      let dateDiffHours = 0;
      let cookieConsentHtml = `
      <div id="cookie-consent">
        <p>
          We use cookies to perform analytics and enhance user experience. Do you accept to the use of cookies?
        </p>
        <p class="cookie-consent-buttons">
          <a id="decline-cookie-btn" class="btn white-button" href="javascript:void(0)">Decline</a>
          <a id="accept-cookie-btn" class="btn blue-button" href="javascript:void(0)">Accept</a>
        </p>
      </div>
      `;
      dateDiffHours = cookieConsentDeclinedDate ? Math.abs(cookieConsentDeclinedDate - today) / 36e5 : 0;
      if (document.cookie.indexOf(cookieName) < 0) {
        if (cookieConsentDeclinedDate) {
          if (dateDiffHours > 24) {
            $("body").append(cookieConsentHtml);
          }
        } else {
          $("body").append(cookieConsentHtml);
        }
      }
      $("#accept-cookie-btn").click(function() {
        document.cookie = `${cookieName}=accept;expires=${expiryTime};path=/`;
        localStorage.removeItem("cookie_consent_declined");
        consentGranted();
        $("#cookie-consent").hide();
      });
      $("#decline-cookie-btn").click(function() {
        localStorage.setItem("cookie_consent_declined", today);
        $("#cookie-consent").hide();
      });
</script>
</body>
</html>