<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Authentication with Keycloak using a OAuth 2 Proxy :: devonfw</title>
    <link rel="canonical" href="https://devonfw.com/docs/java/current/cross_cutting/oauth2_proxy.html">
    <meta name="generator" content="Antora 3.0.2">
    <link rel="stylesheet" href="../../../_/css/site.css">
<meta property="og:title" content="1/cross_cutting/oauth2_proxy.adoc" />    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://devonfw.com/">devonfw</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
    <div class="navbar-end">
        <a class="navbar-item" href="https://devonfw.com/docs/java/current/">Java</a>
        <a class="navbar-item" href="https://devonfw.com/docs/typescript/current/">TypeScript</a>
        <a class="navbar-item" href="https://github.com/devonfw/ide">IDE</a>
        <a class="navbar-item" href="https://github.com/devonfw/hangar">CI/CD</a>
        <a class="navbar-item" href="https://devonfw.com/website/pages/learning/">Tutorials</a>
        <a class="navbar-item" href="https://devonfw.com/website/pages/docs/master.html">Legacy Docs</a>
          <div class="navbar-item search hide-for-print">
            <div id="search-field" class="field">
              <input id="search-input" type="text" placeholder="Search the docs">
            </div>
          </div>
        <a class="navbar-github navbar-item" href="https://github.com/devonfw/"></a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="java" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Java</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../getting_started/getting_started.html">Getting started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../getting_started/create_rest_service.html">Create a REST service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Architecture</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../architecture/layered_architecture.html">Layered Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../architecture/hexagonal_architecture.html">Hexagonal Architecture</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Integration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../integration/rest_service.html">REST</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../integration/rest_exception_handling.html">RESTful Exception Handling</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../integration/rest_service_json.html">JSON</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../integration/rest_openapi.html">Open Api Generator</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Persistence</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Relational Databases</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../persistence/jpa.html">JPA</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../persistence/transactional.html">Transaction</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Cross cutting</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="coding_conventions.html">Coding Conventions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="configuration.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="dependency_injection.html">Dependency Injection</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="exceptions.html">Exceptions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="i18n.html">Internationalization (I18N)</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="oauth2_proxy.html">Authentication with Keycloak using a OAuth 2 Proxy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="logging.html">Logging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Security</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="security/authentication.html">Authentication</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="security/authorization.html">Authorization</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="security/cors.html">CORS</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="security/csrf.html">CSRF</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tracing.html">Tracing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="test_automation/test_automation.html">Test Automation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="test_automation/unit_tests.html">Unit Tests</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="test_automation/sub_system_tests.html">Subsystem- and System-Tests</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="test_automation/contract_tests.html">Consumer Driven Contract (CDC) Tests</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="test_automation/architecture_tests.html">Architecture Tests</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Examples</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../examples/my-thai-star.html">My-Thai-Star Sample Application</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Java</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Java</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../typescript/current/index.html">Typescript</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../typescript/current/index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Java</a></li>
    <li>Cross cutting</li>
    <li><a href="oauth2_proxy.html">Authentication with Keycloak using a OAuth 2 Proxy</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/devonfw/java/edit/main/modules/ROOT/pages/cross_cutting/oauth2_proxy.adoc">Contribute to this page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div id="contribution-overlay" class="contribution-overlay"></div>
<div id="contribution-div" class="contribution">
  <button id="contribution-btn" class="contribution-btn"><span class="close">&times</span></button>
  <div class="contribution-container">
      <div class="contribution-img"> </div>
      <h2> Contribute to help us improve!</h2> 
      <p> Are there edge cases or problems that we didn't consider? Is there a technical pitfall that we should add? Did we miss a comma in a sentence? </p>
      <p> If you have any input for us, we would love to hear from you and appreciate every contribution. Our goal is to learn from projects for projects such that nobody has to reinvent the wheel. </p>
      <p> Let's collect our experiences together to make room to explore the novel! </p> 
      <p> To contribute click on <span class="devonfw-primary-color">Contribute to this page</span> on the toolbar.</p>
  </div>
</div><h1 class="page">Authentication with Keycloak using a OAuth 2 Proxy</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://OAuth2-proxy.github.io/OAuth2-proxy/">OAuth2 proxy</a> is a <a href="https://en.wikipedia.org/wiki/Reverse_proxy">reverse proxy</a> that runs in front of your services to handle the complexity of <a href="https://developer.okta.com/blog/2019/10/21/illustrated-guide-to-OAuth-and-oidc">OpenID Connect / OAuth 2</a>.
Applications behind the proxy can be sure, that requests to them have already been authorized.
The proxy supports a variety of <a href="https://en.wikipedia.org/wiki/Identity_provider">identity providers</a> like Google, GitHub, Keycloak&#8230;&#8203;</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authentication_flow"><a class="anchor" href="#_authentication_flow"></a>Authentication flow</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A detailed flow diagram can be found <a href="https://github.com/oauth2-proxy/oauth2-proxy/issues/1438">here</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup"><a class="anchor" href="#_setup"></a>Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The OAuth 2 proxy can be deployed from a <a href="https://github.com/OAuth2-proxy/OAuth2-proxy/releases/latest">prebuilt binary</a>, a prebuilt <a href="https://quay.io/repository/OAuth2-proxy/OAuth2-proxy?tab=tags&amp;tag=latest">docker image</a> or by <a href="https://github.com/OAuth2-proxy/manifests">helm chart</a> inside a Kubernetes cluster.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/OAuth2_Proxy-RequestFlow.drawio.svg" alt="Request Flow">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Unauthorized request</p>
</li>
<li>
<p>Ingress redirect to OAuth 2 proxy</p>
</li>
<li>
<p>OAuth 2 proxy redirects users browser to the OAuth screen</p>
</li>
<li>
<p>OAuth screen request</p>
</li>
<li>
<p>Ingress redirects to keycloak</p>
</li>
<li>
<p>After a successful login the users browser is redirected to a callback url with auth header</p>
</li>
<li>
<p>Authorized Request</p>
</li>
<li>
<p>Ingress redirect to OAuth 2 proxy</p>
</li>
<li>
<p>OAuth 2 proxy redirect to upstream</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_keycloak"><a class="anchor" href="#_keycloak"></a>Keycloak</h3>
<div class="paragraph">
<p>In this example, <a href="https://www.keycloak.org/">keycloak</a> is used as identity provider. For more details on keycloak read this introduction <a href="https://medium.com/codex/introduction-to-keycloak-227c3902754a">article</a>.
Keycloak can be deployed with variety of deployment <a href="https://www.keycloak.org/guides#getting-started">options</a>.</p>
</div>
<div class="paragraph">
<p>After keycloak is running go to the admin ui and configure a client. Make sure to follow the <a href="https://oauth2-proxy.github.io/oauth2-proxy/docs/configuration/oauth_provider#keycloak-oidc-auth-provider">guide of OAuth 2</a> proxy to set up the group mapping properly.</p>
</div>
</div>
<div class="sect2">
<h3 id="_keycloak_database"><a class="anchor" href="#_keycloak_database"></a>Keycloak Database</h3>
<div class="paragraph">
<p>Keycloak stores it&#8217;s data in a separate database. There is support for different <a href="https://www.keycloak.org/server/db#_supported_databases">database vendors</a>.
For production environments, file and in memory databases should not be used.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ingress"><a class="anchor" href="#_ingress"></a>Ingress</h3>
<div class="paragraph">
<p>The task of the <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">ingress</a> is to redirect all requests to a specific host path to the OAuth 2 proxy and all requests to another host path to the keycloak service. It&#8217;s important to have the keycloak service accessible form outside the cluster to allow redirects to the oauth screen in the users browser.</p>
</div>
<div class="paragraph">
<p>Make sure to have a single ingress controller like <a href="https://docs.nginx.com/nginx-ingress-controller/">nginx</a> running in the cluster to allow the ingress to work properly.</p>
</div>
</div>
<div class="sect2">
<h3 id="_auth2_proxy"><a class="anchor" href="#_auth2_proxy"></a>Auth2 Proxy</h3>
<div class="paragraph">
<p>The OAuth 2 proxy is running between the user and the application. If the user sends a request, the proxy will check the request for the proxy&#8217;s session cookie or a JWT. When the authentication is not provided, the user&#8217;s browser is redirected to the OAuth screen of a configured identity provider. If the request is authorized, the proxy will forward the request to a configured upstream.</p>
</div>
<div class="paragraph">
<p>The proxy can be configured to allow multiple groups access to multiple services. It is not possible to allow different groups to access different services. For a more fine grain access control, allow the services to use the authorization header/Token or use a different authentication system like istio.</p>
</div>
<div class="paragraph">
<p>Minimal configuration:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Option</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Example</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">provider</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The used OAuth provider</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>keycloak-oidc</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">oidc-issuer-url</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The external url of the OpenID Connect service, used in the session cookie</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="http://keycloak.localtest.me/realms/TestRealm" class="bare">http://keycloak.localtest.me/realms/TestRealm</a></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">upstream</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The service or list of services to redirect requests to after they are authenticated</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="http://spring-server-service.default.svc.cluster.local:8090" class="bare">http://spring-server-service.default.svc.cluster.local:8090</a></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">scope</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Scopes that will be added to the OAuth request</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>openid email</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowed-group</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The group or list of groups that are authorized to pass the proxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/adminGroup</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">email-domain</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A string or list to specify the email addresses that are allowed to pass the proxy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>*</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A detailed overview for all configuration option can be found <a href="https://oauth2-proxy.github.io/oauth2-proxy/docs/configuration/overview">here</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_application"><a class="anchor" href="#_application"></a>Application</h3>
<div class="paragraph">
<p>Requests from outside the cluster can only access the application over the main ingress. Because of that, the application can be sure that every request has passed through the OAuth 2 proxy and got authenticated. This has the advantage that the application doesn&#8217;t have to implement security itself.
The application can get access to the authentication header or token to allow a more fine grain authentication.</p>
</div>
</div>
<div class="sect2">
<h3 id="_special_configuration_for_local_testing"><a class="anchor" href="#_special_configuration_for_local_testing"></a>Special configuration for local testing</h3>
<div class="paragraph">
<p>To get a <a href="https://en.wikipedia.org/wiki/Fully_qualified_domain_name">FQDN</a> for the ingress without changing the host file, the example is using the domain <code>localtest.me</code>, which will get resolve to <code>127.0.0.1</code> by a public DNS server.</p>
</div>
<div class="paragraph">
<p>This created some problems.
When trying to access the keycloak server from the proxy, it&#8217;s necessary to use the kubernetes internal URL. Because using the localtest URL will always try to access the loopback device of the pod sending the request.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/OAuth2_Proxy-LocalProblem.drawio.svg" alt="Localhost Problem">
</div>
</div>
<div class="paragraph">
<p>This increased the complexity of the configuration, because the login URL is different from the tokens issuer URL. To resolve this problem, you have to enable <code>skip-oidc-discovery</code> in the OAuth 2 proxy configuration and set all URLs manually.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">oidc-issuer-url = localtest.me
oidc-jwks-url   = keycloak.default.svc.cluster.local
redeem-url      = keycloak.default.svc.cluster.local
login-url       = localtest.me</code></pre>
</div>
</div>
</div>
</div>
</div>
<hr>
<div id="giscus-div">
  <script src="https://giscus.app/client.js"
          data-repo="devonfw/java"
          data-repo-id="R_kgDOISza8Q"
          data-category="Feedback"
          data-category-id="DIC_kwDOISza8c4CSzPy"
          data-mapping="og:title"
          data-strict="0"
          data-reactions-enabled="1"
          data-emit-metadata="0"
          data-input-position="bottom"
          data-theme="light"
          data-lang="en"
          crossorigin="anonymous"
          async>
  </script>
<div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <div class="bottom-footer">
    <ul>
      <li><a href="https://devonfw.com/website/pages/docs/devonfw-guide_ide.wiki_LICENSE.asciidoc.html">Terms of use</a></li>
    </ul>
  </div>
</footer>
<script src="https://cginternal.devonfw.com/communitycontent/main.js"></script>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../.." data-snippet-length="100" data-stylesheet="../../../_/css/search.css"></script>
<script async src="../../../search-index.js"></script>
  </body>
</html>
